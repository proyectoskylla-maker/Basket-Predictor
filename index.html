<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Basket Predictor 2025 ‚Äî v2 (Historial + Kelly)</title>
<link rel="preconnect" href="https://cdn.jsdelivr.net">
<style>
  :root{
    --bg:#071127; --card:#081832; --accent:#06b6d4; --muted:#9fd6e6; --ok:#9ae6b4; --bad:#fca5a5;
  }
  body{font-family:Inter, Arial, sans-serif;background:var(--bg);color:#e6f6ff;padding:18px;margin:0}
  .wrap{max-width:1100px;margin:0 auto;display:grid;grid-template-columns:1fr 420px;gap:16px}
  .card{background:var(--card);padding:14px;border-radius:12px;box-shadow:0 8px 28px rgba(0,0,0,0.6)}
  h1{margin:0 0 8px;color:var(--accent);font-size:20px}
  label{display:block;font-weight:600;margin:8px 0 6px}
  select,input,button,textarea{width:100%;padding:8px;border-radius:8px;border:1px solid #0f1724;background:#0c1624;color:#e6f6ff}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  button.primary{background:var(--accent);border:0;color:#041224;font-weight:700;cursor:pointer}
  button.ghost{background:transparent;border:1px solid #183046;color:var(--muted);cursor:pointer}
  #result{margin-top:10px;padding:10px;border-radius:8px;background:#061525}
  #log{margin-top:10px;padding:10px;border-radius:8px;background:#031426;color:var(--muted);height:120px;overflow:auto;font-size:13px}
  table{width:100%;border-collapse:collapse;font-size:13px;margin-top:8px}
  th,td{padding:6px;border-bottom:1px solid rgba(255,255,255,0.04);text-align:left}
  .ev-pos{color:var(--ok);font-weight:700}
  .ev-neg{color:var(--bad);font-weight:700}
  .history-actions{display:flex;gap:8px;margin-top:8px}
  @media(max-width:980px){ .wrap{grid-template-columns:1fr} }
</style>
<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
</head>
<body>
<div style="max-width:1100px;margin:0 auto 12px">
  <h1>üèÄ Basket Predictor 2025 ‚Äî v2 (Historial, Kelly, Export)</h1>
  <div style="color:#9fd6e6">Prepartido / Live / Historial. Guarda tus an√°lisis y exporta CSV/JSON.</div>
</div>

<div class="wrap">
  <!-- Left: Controls & Chart -->
  <div class="card">
    <label>Liga</label>
    <select id="league"><option value="NBA">NBA</option><option value="EuroLeague">EuroLeague</option></select>

    <div class="row">
      <div>
        <label>Equipo Local</label>
        <select id="teamA"></select>
      </div>
      <div>
        <label>Equipo Visitante</label>
        <select id="teamB"></select>
      </div>
    </div>

    <label>L√≠nea (book total)</label>
    <input id="line" type="number" step="0.1" value="224.5">

    <div class="row">
      <div>
        <label>Modo</label>
        <select id="mode"><option value="pre">Prepartido</option><option value="live">En vivo</option></select>
      </div>
      <div>
        <label>Fraction jugada (si live) ‚Äî 0..1</label>
        <input id="fractionPlayed" type="number" step="0.01" value="0.5">
      </div>
    </div>

    <div id="liveFields" style="display:none;">
      <label>Puntos actuales (total combinado hasta ahora)</label>
      <input id="currentPoints" type="number" step="1" value="0">
    </div>

    <div class="row">
      <div>
        <label>Cuota Over (decimal)</label>
        <input id="oddsOver" type="number" step="0.01" value="1.90">
      </div>
      <div>
        <label>Cuota Under (decimal)</label>
        <input id="oddsUnder" type="number" step="0.01" value="1.90">
      </div>
    </div>

    <div style="display:flex;gap:8px;margin-top:10px">
      <button id="calcBtn" class="primary">Calcular & Guardar</button>
      <button id="clearInputs" class="ghost">Reset Inputs</button>
    </div>

    <div id="result"></div>

    <canvas id="chart" style="margin-top:12px"></canvas>

    <div id="log"></div>
  </div>

  <!-- Right: Kelly, History, Export -->
  <div class="card">
    <h3 style="margin:0 0 8px">Resultados & Gesti√≥n</h3>

    <div id="metricsBox" style="display:grid;gap:8px">
      <div><strong>EV Over:</strong> <span id="evOverTxt">‚Äî</span></div>
      <div><strong>EV Under:</strong> <span id="evUnderTxt">‚Äî</span></div>
      <div><strong>Kelly (Over):</strong> <span id="kellyOver">‚Äî</span></div>
      <div><strong>Kelly (Under):</strong> <span id="kellyUnder">‚Äî</span></div>
      <div><strong>Stake sugerido (Kelly fracc.):</strong> <span id="stakeSuggest">‚Äî</span></div>
    </div>

    <hr style="margin:12px 0;border-color:rgba(255,255,255,0.04)">

    <div style="display:flex;justify-content:space-between;align-items:center">
      <h4 style="margin:0">Historial</h4>
      <div style="display:flex;gap:8px">
        <button id="exportJson" class="ghost">Export JSON</button>
        <button id="exportCsv" class="ghost">Export CSV</button>
      </div>
    </div>

    <div id="historyWrapper" style="max-height:340px;overflow:auto;margin-top:8px">
      <table id="historyTable"><thead><tr><th>#</th><th>Fecha</th><th>Match</th><th>Line</th><th>POver</th><th>EV%</th><th>Kelly%</th></tr></thead><tbody></tbody></table>
    </div>

    <div class="history-actions" style="margin-top:8px">
      <button id="clearHistory" class="ghost">Limpiar Historial</button>
      <button id="applyKellyFrac" class="ghost">Usar Kelly 0.5 (frac)</button>
    </div>

    <div style="margin-top:10px;font-size:13px;color:var(--muted)">
      Nota: Kelly calculado como fracci√≥n completa; se muestra % (multiplica por bankroll si aplicas). Ajusta fracciones si quieres conservador.
    </div>
  </div>
</div>

<script>
// -------------------- Datos (NBA + EuroLeague) --------------------
const DATA = {
  "NBA": {
    "Atlanta Hawks": {"mean":235.2,"std":9.8},"Boston Celtics":{"mean":224.1,"std":8.7},
    "Brooklyn Nets":{"mean":220.3,"std":9.2},"Charlotte Hornets":{"mean":229.7,"std":9.5},
    "Chicago Bulls":{"mean":221.5,"std":8.8},"Cleveland Cavaliers":{"mean":218.4,"std":8.9},
    "Dallas Mavericks":{"mean":229.9,"std":9.7},"Denver Nuggets":{"mean":226.8,"std":9.3},
    "Detroit Pistons":{"mean":225.3,"std":9.1},"Golden State Warriors":{"mean":234.2,"std":10.4},
    "Houston Rockets":{"mean":222.7,"std":8.8},"Indiana Pacers":{"mean":240.5,"std":10.1},
    "Los Angeles Clippers":{"mean":226.9,"std":9.0},"Los Angeles Lakers":{"mean":228.7,"std":9.6},
    "Memphis Grizzlies":{"mean":222.3,"std":8.7},"Miami Heat":{"mean":216.8,"std":8.5},
    "Milwaukee Bucks":{"mean":231.6,"std":9.9},"Minnesota Timberwolves":{"mean":220.2,"std":8.7},
    "New Orleans Pelicans":{"mean":228.1,"std":9.2},"New York Knicks":{"mean":218.9,"std":8.8},
    "Oklahoma City Thunder":{"mean":231.1,"std":9.5},"Orlando Magic":{"mean":217.3,"std":8.6},
    "Philadelphia 76ers":{"mean":225.9,"std":9.1},"Phoenix Suns":{"mean":227.8,"std":9.0},
    "Portland Trail Blazers":{"mean":226.2,"std":9.3},"Sacramento Kings":{"mean":233.4,"std":9.8},
    "San Antonio Spurs":{"mean":231.0,"std":9.9},"Toronto Raptors":{"mean":224.8,"std":8.8},
    "Utah Jazz":{"mean":230.3,"std":9.4},"Washington Wizards":{"mean":232.1,"std":9.7}
  },
  "EuroLeague": {
    "Real Madrid":{"mean":163.8,"std":6.5},"Barcelona":{"mean":160.7,"std":6.7},
    "Olympiacos":{"mean":158.2,"std":6.3},"Panathinaikos":{"mean":157.9,"std":6.2},
    "Fenerbahce":{"mean":159.1,"std":6.5},"Anadolu Efes":{"mean":161.3,"std":6.6},
    "Monaco":{"mean":162.4,"std":6.5},"Virtus Bologna":{"mean":158.7,"std":6.4},
    "Bayern Munich":{"mean":155.4,"std":6.3},"Partizan":{"mean":161.8,"std":6.6},
    "Maccabi Tel Aviv":{"mean":163.5,"std":6.7},"Zalgiris Kaunas":{"mean":156.8,"std":6.3},
    "Valencia":{"mean":157.4,"std":6.4},"Baskonia":{"mean":160.9,"std":6.6},
    "ALBA Berlin":{"mean":154.8,"std":6.2},"ASVEL Lyon":{"mean":155.2,"std":6.3},
    "Estrella Roja": {"mean": 157.1, "std": 6.3},"Olimpia Milano": {"mean": 156.6, "std": 6.2},
    "Paris Basketball": {"mean": 159.3, "std": 6.4},"Hapoel Tel Aviv": {"mean": 158.5, "std": 6.3},
    "Dubai": {"mean": 160.1, "std":  6.5}
  }
};

// -------------------- Utilidades --------------------
function erf(x){
  const sign = x >= 0 ? 1 : -1; x = Math.abs(x);
  const a1=0.254829592,a2=-0.284496736,a3=1.421413741,a4=-1.453152027,a5=1.061405429,p=0.3275911;
  const t = 1/(1 + p*x);
  const y = 1 - ((((a5*t + a4)*t + a3)*t + a2)*t + a1) * t * Math.exp(-x*x);
  return sign * y;
}
function normalCdf(z){ return 0.5 * (1 + erf(z / Math.SQRT2)); }

// -------------------- DOM Refs --------------------
const leagueSel = document.getElementById('league');
const teamASel = document.getElementById('teamA');
const teamBSel = document.getElementById('teamB');
const modeSel = document.getElementById('mode');
const liveFields = document.getElementById('liveFields');
const currentPointsInput = document.getElementById('currentPoints');
const fractionPlayedInput = document.getElementById('fractionPlayed');
const lineInput = document.getElementById('line');
const oddsOverInput = document.getElementById('oddsOver');
const oddsUnderInput = document.getElementById('oddsUnder');
const calcBtn = document.getElementById('calcBtn');
const resultDiv = document.getElementById('result');
const logDiv = document.getElementById('log');
const historyTableBody = document.querySelector('#historyTable tbody');
const evOverTxt = document.getElementById('evOverTxt');
const evUnderTxt = document.getElementById('evUnderTxt');
const kellyOverTxt = document.getElementById('kellyOver');
const kellyUnderTxt = document.getElementById('kellyUnder');
const stakeSuggestTxt = document.getElementById('stakeSuggest');

let chartInst = null;

// -------------------- Inicializaci√≥n --------------------
function fillTeams(){
  const league = leagueSel.value;
  const teams = Object.keys(DATA[league]).sort();
  const optHtml = teams.map(t => `<option value="${t}">${t}</option>`).join('');
  teamASel.innerHTML = '<option value="">-- seleccionar --</option>' + optHtml;
  teamBSel.innerHTML = '<option value="">-- seleccionar --</option>' + optHtml;
  log(`Equipos cargados para ${league} (${teams.length})`);
}
leagueSel.addEventListener('change', fillTeams);
modeSel.addEventListener('change', ()=> liveFields.style.display = modeSel.value === 'live' ? 'block' : 'none');

document.addEventListener('DOMContentLoaded', ()=> {
  fillTeams();
  loadHistory();
  log('Interfaz lista (v2).');
});

// -------------------- Historial (localStorage) --------------------
const HISTORY_KEY = 'bp_v2_history';
function loadHistory(){
  try{
    const raw = localStorage.getItem(HISTORY_KEY);
    const arr = raw ? JSON.parse(raw) : [];
    renderHistory(arr);
  }catch(e){ log('Error loadHistory: ' + e.message); }
}
function saveToHistory(entry){
  try{
    const raw = localStorage.getItem(HISTORY_KEY);
    const arr = raw ? JSON.parse(raw) : [];
    arr.unshift(entry); // push front
    localStorage.setItem(HISTORY_KEY, JSON.stringify(arr.slice(0,500))); // cap 500
    renderHistory(arr);
  }catch(e){ log('Error saveHistory: ' + e.message); }
}
function renderHistory(arr){
  historyTableBody.innerHTML = '';
  arr = arr || [];
  arr.forEach((h,i) => {
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${i+1}</td><td>${new Date(h.ts).toLocaleString()}</td><td>${h.league}: ${h.home} vs ${h.away}</td><td>${h.line}</td><td>${(h.probOver*100).toFixed(2)}%</td><td>${(h.evOver*100).toFixed(2)}%</td><td>${(h.kellyOver*100).toFixed(2)}%</td>`;
    historyTableBody.appendChild(tr);
  });
}

// -------------------- Export / Clear --------------------
function exportJSON(){
  const raw = localStorage.getItem(HISTORY_KEY) || '[]';
  const blob = new Blob([raw], {type:'application/json'});
  const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download='bp_history.json'; a.click();
  URL.revokeObjectURL(a.href);
}
function exportCSV(){
  const raw = localStorage.getItem(HISTORY_KEY) || '[]';
  const arr = JSON.parse(raw);
  if(!arr.length){ alert('No hay historial'); return; }
  const header = ['ts,league,home,away,line,probOver,evOver,kellyOver'];
  const rows = arr.map(r => `${r.ts},${r.league},${r.home},${r.away},${r.line},${r.probOver},${r.evOver},${r.kellyOver}`);
  const csv = header.concat(rows).join('\n');
  const blob = new Blob([csv], {type:'text/csv'});
  const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download='bp_history.csv'; a.click();
  URL.revokeObjectURL(a.href);
}
document.getElementById('exportJson').addEventListener('click', exportJSON);
document.getElementById('exportCsv').addEventListener('click', exportCSV);
document.getElementById('clearHistory').addEventListener('click', ()=>{ if(confirm('Borrar historial?')){ localStorage.removeItem(HISTORY_KEY); renderHistory([]); log('Historial borrado'); }});
document.getElementById('clearInputs').addEventListener('click', ()=>{ lineInput.value='224.5'; oddsOverInput.value='1.90'; oddsUnderInput.value='1.90'; currentPointsInput.value='0'; fractionPlayedInput.value='0.5'; });

// -------------------- C√°lculo & Kelly --------------------
function computeKelly(p, odds){
  // b = net odds: e.g. odds 1.90 -> b = 0.90
  const b = odds - 1;
  // Kelly formula: k = (p*(b) - (1-p)) / b
  if(b <= 0) return 0;
  const k = (p * b - (1 - p)) / b;
  return k;
}

function safeDrawChart(mean, std, line){
  try{
    if(typeof Chart === 'undefined'){ log('Chart.js no disponible ‚Äî omitiendo gr√°fico'); return; }
    const ctx = document.getElementById('chart').getContext('2d');
    const xs = []; const ys = [];
    for(let x = Math.round(mean-40); x <= Math.round(mean+40); x++){
      xs.push(x);
      ys.push((1/(std*Math.sqrt(2*Math.PI))) * Math.exp(-0.5 * Math.pow((x-mean)/std,2)));
    }
    const ymax = Math.max(...ys) || 1;
    // dataset for vertical line: put null except nearest index
    const lineData = xs.map(x => Math.abs(x - Math.round(line)) <= 0 ? ymax : null);
    if(chartInst) chartInst.destroy();
    chartInst = new Chart(ctx, {
      type:'line',
      data:{ labels: xs, datasets:[
        { label:'Densidad aprox', data: ys, borderColor: '#06b6d4', tension:0.2, fill:false },
        { label:'L√≠nea', data: xs.map(x => x === Math.round(line) ? ymax : null), borderColor:'#fb7185', borderWidth:2, pointRadius:0, showLine:true }
      ]},
      options:{ plugins:{legend:{labels:{color:'#d1f5fb'}}}, scales:{ x:{ticks:{color:'#bfeaf2'}}, y:{display:false} } }
    });
  }catch(e){ log('Error gr√°fico: ' + e.message); console.error(e); }
}

function calcularGuardar(){
  try{
    // read inputs
    const league = leagueSel.value;
    const home = teamASel.value;
    const away = teamBSel.value;
    if(!home || !away){ alert('Selecciona ambos equipos'); return; }
    if(home === away){ alert('Elige equipos distintos'); return; }

    const line = parseFloat(lineInput.value);
    const oddsOver = parseFloat(oddsOverInput.value);
    const oddsUnder = parseFloat(oddsUnderInput.value);
    if(Number.isNaN(line) || Number.isNaN(oddsOver) || Number.isNaN(oddsUnder)){ alert('Inputs inv√°lidos'); return; }

    // base stats
    let mean = (DATA[league][home].mean + DATA[league][away].mean) / 2;
    let std = Math.sqrt((Math.pow(DATA[league][home].std,2) + Math.pow(DATA[league][away].std,2)) / 2);

    // live adjustment
    if(modeSel.value === 'live'){
      const ptsAct = parseFloat(currentPointsInput.value);
      const frac = parseFloat(fractionPlayedInput.value);
      if(Number.isNaN(ptsAct) || Number.isNaN(frac) || frac <= 0 || frac >= 1){ alert('Live: inputs inv√°lidos (0 < frac < 1)'); return; }
      const restante = 1 - frac;
      const meanRest = mean * restante;
      const stdRest = std * Math.sqrt(restante);
      mean = ptsAct + meanRest;
      std = stdRest;
      log(`Live adjust: ptsAct=${ptsAct}, frac=${frac}, meanRest=${meanRest.toFixed(2)}, stdRest=${stdRest.toFixed(2)}`);
    }

    // probability
    const z = (line - mean) / std;
    const probOver = 1 - normalCdf(z);
    const probUnder = 1 - probOver;

    // EV
    const evOver = probOver * oddsOver - 1;
    const evUnder = probUnder * oddsUnder - 1;

    // Kelly
    const kOver = computeKelly(probOver, oddsOver);
    const kUnder = computeKelly(probUnder, oddsUnder);
    const kOverPct = Math.max(0, kOver); // only positive
    const kUnderPct = Math.max(0, kUnder);

    // show metrics
    evOverTxt.innerText = (evOver*100).toFixed(2) + '%';
    evUnderTxt.innerText = (evUnder*100).toFixed(2) + '%';
    kellyOverTxt.innerText = (kOver*100).toFixed(2) + '%';
    kellyUnderTxt.innerText = (kUnder*100).toFixed(2) + '%';
    // stake suggestion: use fractional Kelly (0.5)
    const suggested = Math.max(0, kOver*0.5) * 100;
    stakeSuggestTxt.innerText = suggested.toFixed(2) + '% (Kelly 0.5 for Over)';

    // display result
    resultDiv.innerHTML = `<strong>${home} vs ${away} (${league})</strong><br>
      Line: ${line} ‚Äî Mean est.: ${mean.toFixed(2)} ‚Äî Std aprox: ${std.toFixed(2)}<br>
      Prob Over: ${(probOver*100).toFixed(2)}% ‚Äî EV Over: ${(evOver*100).toFixed(2)}%<br>
      Kelly Over: ${(kOver*100).toFixed(2)}% ‚Äî Suggested stake (Kelly 0.5): ${suggested.toFixed(2)}%`;

    // draw chart
    safeDrawChart(mean, std, line);

    // save entry
    const entry = {
      ts: Date.now(), league, home, away, line,
      probOver, probUnder, evOver, evUnder,
      oddsOver, oddsUnder, kellyOver: kOver, kellyUnder: kUnder
    };
    saveToHistory(entry);

    log(`Saved: ${home} vs ${away} | POver ${(probOver*100).toFixed(2)}% | EV ${(evOver*100).toFixed(2)}%`);
  }catch(e){ log('Error calcularGuardar: ' + (e.message||e)); console.error(e); resultDiv.innerText = 'Error: ' + (e.message||e); }
}

calcBtn.addEventListener('click', calcularGuardar);

// -------------------- Small helpers --------------------
function log(msg){ const ts = new Date().toLocaleTimeString(); logDiv.innerHTML = `[${ts}] ${msg}<br>` + logDiv.innerHTML; }
document.getElementById('applyKellyFrac').addEventListener('click', ()=>{ /* placeholder: could apply to bankroll */ alert('Aplicar√° Kelly 0.5 sobre stake si implementas bankroll.'); });

// -------------------- Init UI events --------------------
document.getElementById('exampleBtn').addEventListener('click', ()=>{
  leagueSel.value='NBA'; fillTeams();
  teamASel.value='Los Angeles Lakers'; teamBSel.value='Chicago Bulls';
  lineInput.value='224.5'; oddsOverInput.value='1.90'; oddsUnderInput.value='1.90';
  modeSel.value='pre'; liveFields.style.display='none';
  log('Ejemplo cargado: Lakers vs Bulls');
});
document.getElementById('exportJson').addEventListener('click', exportJSON);
document.getElementById('exportCsv').addEventListener('click', exportCSV);

</script>
</body>
</html><!doctype html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Basket Predictor 2025 ‚Äî v2 (Historial + Kelly)</title>
<link rel="preconnect" href="https://cdn.jsdelivr.net">
<style>
  :root{
    --bg:#071127; --card:#081832; --accent:#06b6d4; --muted:#9fd6e6; --ok:#9ae6b4; --bad:#fca5a5;
  }
  body{font-family:Inter, Arial, sans-serif;background:var(--bg);color:#e6f6ff;padding:18px;margin:0}
  .wrap{max-width:1100px;margin:0 auto;display:grid;grid-template-columns:1fr 420px;gap:16px}
  .card{background:var(--card);padding:14px;border-radius:12px;box-shadow:0 8px 28px rgba(0,0,0,0.6)}
  h1{margin:0 0 8px;color:var(--accent);font-size:20px}
  label{display:block;font-weight:600;margin:8px 0 6px}
  select,input,button,textarea{width:100%;padding:8px;border-radius:8px;border:1px solid #0f1724;background:#0c1624;color:#e6f6ff}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  button.primary{background:var(--accent);border:0;color:#041224;font-weight:700;cursor:pointer}
  button.ghost{background:transparent;border:1px solid #183046;color:var(--muted);cursor:pointer}
  #result{margin-top:10px;padding:10px;border-radius:8px;background:#061525}
  #log{margin-top:10px;padding:10px;border-radius:8px;background:#031426;color:var(--muted);height:120px;overflow:auto;font-size:13px}
  table{width:100%;border-collapse:collapse;font-size:13px;margin-top:8px}
  th,td{padding:6px;border-bottom:1px solid rgba(255,255,255,0.04);text-align:left}
  .ev-pos{color:var(--ok);font-weight:700}
  .ev-neg{color:var(--bad);font-weight:700}
  .history-actions{display:flex;gap:8px;margin-top:8px}
  @media(max-width:980px){ .wrap{grid-template-columns:1fr} }
</style>
<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
</head>
<body>
<div style="max-width:1100px;margin:0 auto 12px">
  <h1>üèÄ Basket Predictor 2025 ‚Äî v2 (Historial, Kelly, Export)</h1>
  <div style="color:#9fd6e6">Prepartido / Live / Historial. Guarda tus an√°lisis y exporta CSV/JSON.</div>
</div>

<div class="wrap">
  <!-- Left: Controls & Chart -->
  <div class="card">
    <label>Liga</label>
    <select id="league"><option value="NBA">NBA</option><option value="EuroLeague">EuroLeague</option></select>

    <div class="row">
      <div>
        <label>Equipo Local</label>
        <select id="teamA"></select>
      </div>
      <div>
        <label>Equipo Visitante</label>
        <select id="teamB"></select>
      </div>
    </div>

    <label>L√≠nea (book total)</label>
    <input id="line" type="number" step="0.1" value="224.5">

    <div class="row">
      <div>
        <label>Modo</label>
        <select id="mode"><option value="pre">Prepartido</option><option value="live">En vivo</option></select>
      </div>
      <div>
        <label>Fraction jugada (si live) ‚Äî 0..1</label>
        <input id="fractionPlayed" type="number" step="0.01" value="0.5">
      </div>
    </div>

    <div id="liveFields" style="display:none;">
      <label>Puntos actuales (total combinado hasta ahora)</label>
      <input id="currentPoints" type="number" step="1" value="0">
    </div>

    <div class="row">
      <div>
        <label>Cuota Over (decimal)</label>
        <input id="oddsOver" type="number" step="0.01" value="1.90">
      </div>
      <div>
        <label>Cuota Under (decimal)</label>
        <input id="oddsUnder" type="number" step="0.01" value="1.90">
      </div>
    </div>

    <div style="display:flex;gap:8px;margin-top:10px">
      <button id="calcBtn" class="primary">Calcular & Guardar</button>
      <button id="clearInputs" class="ghost">Reset Inputs</button>
    </div>

    <div id="result"></div>

    <canvas id="chart" style="margin-top:12px"></canvas>

    <div id="log"></div>
  </div>

  <!-- Right: Kelly, History, Export -->
  <div class="card">
    <h3 style="margin:0 0 8px">Resultados & Gesti√≥n</h3>

    <div id="metricsBox" style="display:grid;gap:8px">
      <div><strong>EV Over:</strong> <span id="evOverTxt">‚Äî</span></div>
      <div><strong>EV Under:</strong> <span id="evUnderTxt">‚Äî</span></div>
      <div><strong>Kelly (Over):</strong> <span id="kellyOver">‚Äî</span></div>
      <div><strong>Kelly (Under):</strong> <span id="kellyUnder">‚Äî</span></div>
      <div><strong>Stake sugerido (Kelly fracc.):</strong> <span id="stakeSuggest">‚Äî</span></div>
    </div>

    <hr style="margin:12px 0;border-color:rgba(255,255,255,0.04)">

    <div style="display:flex;justify-content:space-between;align-items:center">
      <h4 style="margin:0">Historial</h4>
      <div style="display:flex;gap:8px">
        <button id="exportJson" class="ghost">Export JSON</button>
        <button id="exportCsv" class="ghost">Export CSV</button>
      </div>
    </div>

    <div id="historyWrapper" style="max-height:340px;overflow:auto;margin-top:8px">
      <table id="historyTable"><thead><tr><th>#</th><th>Fecha</th><th>Match</th><th>Line</th><th>POver</th><th>EV%</th><th>Kelly%</th></tr></thead><tbody></tbody></table>
    </div>

    <div class="history-actions" style="margin-top:8px">
      <button id="clearHistory" class="ghost">Limpiar Historial</button>
      <button id="applyKellyFrac" class="ghost">Usar Kelly 0.5 (frac)</button>
    </div>

    <div style="margin-top:10px;font-size:13px;color:var(--muted)">
      Nota: Kelly calculado como fracci√≥n completa; se muestra % (multiplica por bankroll si aplicas). Ajusta fracciones si quieres conservador.
    </div>
  </div>
</div>

<script>
// -------------------- Datos (NBA + EuroLeague) --------------------
const DATA = {
  "NBA": {
    "Atlanta Hawks": {"mean":235.2,"std":9.8},"Boston Celtics":{"mean":224.1,"std":8.7},
    "Brooklyn Nets":{"mean":220.3,"std":9.2},"Charlotte Hornets":{"mean":229.7,"std":9.5},
    "Chicago Bulls":{"mean":221.5,"std":8.8},"Cleveland Cavaliers":{"mean":218.4,"std":8.9},
    "Dallas Mavericks":{"mean":229.9,"std":9.7},"Denver Nuggets":{"mean":226.8,"std":9.3},
    "Detroit Pistons":{"mean":225.3,"std":9.1},"Golden State Warriors":{"mean":234.2,"std":10.4},
    "Houston Rockets":{"mean":222.7,"std":8.8},"Indiana Pacers":{"mean":240.5,"std":10.1},
    "Los Angeles Clippers":{"mean":226.9,"std":9.0},"Los Angeles Lakers":{"mean":228.7,"std":9.6},
    "Memphis Grizzlies":{"mean":222.3,"std":8.7},"Miami Heat":{"mean":216.8,"std":8.5},
    "Milwaukee Bucks":{"mean":231.6,"std":9.9},"Minnesota Timberwolves":{"mean":220.2,"std":8.7},
    "New Orleans Pelicans":{"mean":228.1,"std":9.2},"New York Knicks":{"mean":218.9,"std":8.8},
    "Oklahoma City Thunder":{"mean":231.1,"std":9.5},"Orlando Magic":{"mean":217.3,"std":8.6},
    "Philadelphia 76ers":{"mean":225.9,"std":9.1},"Phoenix Suns":{"mean":227.8,"std":9.0},
    "Portland Trail Blazers":{"mean":226.2,"std":9.3},"Sacramento Kings":{"mean":233.4,"std":9.8},
    "San Antonio Spurs":{"mean":231.0,"std":9.9},"Toronto Raptors":{"mean":224.8,"std":8.8},
    "Utah Jazz":{"mean":230.3,"std":9.4},"Washington Wizards":{"mean":232.1,"std":9.7}
  },
    "EuroLeague": {
    "Real Madrid":{"mean":163.8,"std":6.5},"Barcelona":{"mean":160.7,"std":6.7},
    "Olympiacos":{"mean":158.2,"std":6.3},"Panathinaikos":{"mean":157.9,"std":6.2},
    "Fenerbahce":{"mean":159.1,"std":6.5},"Anadolu Efes":{"mean":161.3,"std":6.6},
    "Monaco":{"mean":162.4,"std":6.5},"Virtus Bologna":{"mean":158.7,"std":6.4},
    "Bayern Munich":{"mean":155.4,"std":6.3},"Partizan":{"mean":161.8,"std":6.6},
    "Maccabi Tel Aviv":{"mean":163.5,"std":6.7},"Zalgiris Kaunas":{"mean":156.8,"std":6.3},
    "Valencia":{"mean":157.4,"std":6.4},"Baskonia":{"mean":160.9,"std":6.6},
    "ALBA Berlin":{"mean":154.8,"std":6.2},"ASVEL Lyon":{"mean":155.2,"std":6.3},
    "Estrella Roja": {"mean": 157.1, "std": 6.3},"Olimpia Milano": {"mean": 156.6, "std": 6.2},
    "Paris Basketball": {"mean": 159.3, "std": 6.4},"Hapoel Tel Aviv": {"mean": 158.5, "std": 6.3},
    "Dubai": {"mean": 160.1, "std":  6.5}
  }
};

// -------------------- Utilidades --------------------
function erf(x){
  const sign = x >= 0 ? 1 : -1; x = Math.abs(x);
  const a1=0.254829592,a2=-0.284496736,a3=1.421413741,a4=-1.453152027,a5=1.061405429,p=0.3275911;
  const t = 1/(1 + p*x);
  const y = 1 - ((((a5*t + a4)*t + a3)*t + a2)*t + a1) * t * Math.exp(-x*x);
  return sign * y;
}
function normalCdf(z){ return 0.5 * (1 + erf(z / Math.SQRT2)); }

// -------------------- DOM Refs --------------------
const leagueSel = document.getElementById('league');
const teamASel = document.getElementById('teamA');
const teamBSel = document.getElementById('teamB');
const modeSel = document.getElementById('mode');
const liveFields = document.getElementById('liveFields');
const currentPointsInput = document.getElementById('currentPoints');
const fractionPlayedInput = document.getElementById('fractionPlayed');
const lineInput = document.getElementById('line');
const oddsOverInput = document.getElementById('oddsOver');
const oddsUnderInput = document.getElementById('oddsUnder');
const calcBtn = document.getElementById('calcBtn');
const resultDiv = document.getElementById('result');
const logDiv = document.getElementById('log');
const historyTableBody = document.querySelector('#historyTable tbody');
const evOverTxt = document.getElementById('evOverTxt');
const evUnderTxt = document.getElementById('evUnderTxt');
const kellyOverTxt = document.getElementById('kellyOver');
const kellyUnderTxt = document.getElementById('kellyUnder');
const stakeSuggestTxt = document.getElementById('stakeSuggest');

let chartInst = null;

// -------------------- Inicializaci√≥n --------------------
function fillTeams(){
  const league = leagueSel.value;
  const teams = Object.keys(DATA[league]).sort();
  const optHtml = teams.map(t => `<option value="${t}">${t}</option>`).join('');
  teamASel.innerHTML = '<option value="">-- seleccionar --</option>' + optHtml;
  teamBSel.innerHTML = '<option value="">-- seleccionar --</option>' + optHtml;
  log(`Equipos cargados para ${league} (${teams.length})`);
}
leagueSel.addEventListener('change', fillTeams);
modeSel.addEventListener('change', ()=> liveFields.style.display = modeSel.value === 'live' ? 'block' : 'none');

document.addEventListener('DOMContentLoaded', ()=> {
  fillTeams();
  loadHistory();
  log('Interfaz lista (v2).');
});

// -------------------- Historial (localStorage) --------------------
const HISTORY_KEY = 'bp_v2_history';
function loadHistory(){
  try{
    const raw = localStorage.getItem(HISTORY_KEY);
    const arr = raw ? JSON.parse(raw) : [];
    renderHistory(arr);
  }catch(e){ log('Error loadHistory: ' + e.message); }
}
function saveToHistory(entry){
  try{
    const raw = localStorage.getItem(HISTORY_KEY);
    const arr = raw ? JSON.parse(raw) : [];
    arr.unshift(entry); // push front
    localStorage.setItem(HISTORY_KEY, JSON.stringify(arr.slice(0,500))); // cap 500
    renderHistory(arr);
  }catch(e){ log('Error saveHistory: ' + e.message); }
}
function renderHistory(arr){
  historyTableBody.innerHTML = '';
  arr = arr || [];
  arr.forEach((h,i) => {
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${i+1}</td><td>${new Date(h.ts).toLocaleString()}</td><td>${h.league}: ${h.home} vs ${h.away}</td><td>${h.line}</td><td>${(h.probOver*100).toFixed(2)}%</td><td>${(h.evOver*100).toFixed(2)}%</td><td>${(h.kellyOver*100).toFixed(2)}%</td>`;
    historyTableBody.appendChild(tr);
  });
}

// -------------------- Export / Clear --------------------
function exportJSON(){
  const raw = localStorage.getItem(HISTORY_KEY) || '[]';
  const blob = new Blob([raw], {type:'application/json'});
  const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download='bp_history.json'; a.click();
  URL.revokeObjectURL(a.href);
}
function exportCSV(){
  const raw = localStorage.getItem(HISTORY_KEY) || '[]';
  const arr = JSON.parse(raw);
  if(!arr.length){ alert('No hay historial'); return; }
  const header = ['ts,league,home,away,line,probOver,evOver,kellyOver'];
  const rows = arr.map(r => `${r.ts},${r.league},${r.home},${r.away},${r.line},${r.probOver},${r.evOver},${r.kellyOver}`);
  const csv = header.concat(rows).join('\n');
  const blob = new Blob([csv], {type:'text/csv'});
  const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download='bp_history.csv'; a.click();
  URL.revokeObjectURL(a.href);
}
document.getElementById('exportJson').addEventListener('click', exportJSON);
document.getElementById('exportCsv').addEventListener('click', exportCSV);
document.getElementById('clearHistory').addEventListener('click', ()=>{ if(confirm('Borrar historial?')){ localStorage.removeItem(HISTORY_KEY); renderHistory([]); log('Historial borrado'); }});
document.getElementById('clearInputs').addEventListener('click', ()=>{ lineInput.value='224.5'; oddsOverInput.value='1.90'; oddsUnderInput.value='1.90'; currentPointsInput.value='0'; fractionPlayedInput.value='0.5'; });

// -------------------- C√°lculo & Kelly --------------------
function computeKelly(p, odds){
  // b = net odds: e.g. odds 1.90 -> b = 0.90
  const b = odds - 1;
  // Kelly formula: k = (p*(b) - (1-p)) / b
  if(b <= 0) return 0;
  const k = (p * b - (1 - p)) / b;
  return k;
}

function safeDrawChart(mean, std, line){
  try{
    if(typeof Chart === 'undefined'){ log('Chart.js no disponible ‚Äî omitiendo gr√°fico'); return; }
    const ctx = document.getElementById('chart').getContext('2d');
    const xs = []; const ys = [];
    for(let x = Math.round(mean-40); x <= Math.round(mean+40); x++){
      xs.push(x);
      ys.push((1/(std*Math.sqrt(2*Math.PI))) * Math.exp(-0.5 * Math.pow((x-mean)/std,2)));
    }
    const ymax = Math.max(...ys) || 1;
    // dataset for vertical line: put null except nearest index
    const lineData = xs.map(x => Math.abs(x - Math.round(line)) <= 0 ? ymax : null);
    if(chartInst) chartInst.destroy();
    chartInst = new Chart(ctx, {
      type:'line',
      data:{ labels: xs, datasets:[
        { label:'Densidad aprox', data: ys, borderColor: '#06b6d4', tension:0.2, fill:false },
        { label:'L√≠nea', data: xs.map(x => x === Math.round(line) ? ymax : null), borderColor:'#fb7185', borderWidth:2, pointRadius:0, showLine:true }
      ]},
      options:{ plugins:{legend:{labels:{color:'#d1f5fb'}}}, scales:{ x:{ticks:{color:'#bfeaf2'}}, y:{display:false} } }
    });
  }catch(e){ log('Error gr√°fico: ' + e.message); console.error(e); }
}

function calcularGuardar(){
  try{
    // read inputs
    const league = leagueSel.value;
    const home = teamASel.value;
    const away = teamBSel.value;
    if(!home || !away){ alert('Selecciona ambos equipos'); return; }
    if(home === away){ alert('Elige equipos distintos'); return; }

    const line = parseFloat(lineInput.value);
    const oddsOver = parseFloat(oddsOverInput.value);
    const oddsUnder = parseFloat(oddsUnderInput.value);
    if(Number.isNaN(line) || Number.isNaN(oddsOver) || Number.isNaN(oddsUnder)){ alert('Inputs inv√°lidos'); return; }

    // base stats
    let mean = (DATA[league][home].mean + DATA[league][away].mean) / 2;
    let std = Math.sqrt((Math.pow(DATA[league][home].std,2) + Math.pow(DATA[league][away].std,2)) / 2);

    // live adjustment
    if(modeSel.value === 'live'){
      const ptsAct = parseFloat(currentPointsInput.value);
      const frac = parseFloat(fractionPlayedInput.value);
      if(Number.isNaN(ptsAct) || Number.isNaN(frac) || frac <= 0 || frac >= 1){ alert('Live: inputs inv√°lidos (0 < frac < 1)'); return; }
      const restante = 1 - frac;
      const meanRest = mean * restante;
      const stdRest = std * Math.sqrt(restante);
      mean = ptsAct + meanRest;
      std = stdRest;
      log(`Live adjust: ptsAct=${ptsAct}, frac=${frac}, meanRest=${meanRest.toFixed(2)}, stdRest=${stdRest.toFixed(2)}`);
    }

    // probability
    const z = (line - mean) / std;
    const probOver = 1 - normalCdf(z);
    const probUnder = 1 - probOver;

    // EV
    const evOver = probOver * oddsOver - 1;
    const evUnder = probUnder * oddsUnder - 1;

    // Kelly
    const kOver = computeKelly(probOver, oddsOver);
    const kUnder = computeKelly(probUnder, oddsUnder);
    const kOverPct = Math.max(0, kOver); // only positive
    const kUnderPct = Math.max(0, kUnder);

    // show metrics
    evOverTxt.innerText = (evOver*100).toFixed(2) + '%';
    evUnderTxt.innerText = (evUnder*100).toFixed(2) + '%';
    kellyOverTxt.innerText = (kOver*100).toFixed(2) + '%';
    kellyUnderTxt.innerText = (kUnder*100).toFixed(2) + '%';
    // stake suggestion: use fractional Kelly (0.5)
    const suggested = Math.max(0, kOver*0.5) * 100;
    stakeSuggestTxt.innerText = suggested.toFixed(2) + '% (Kelly 0.5 for Over)';

    // display result
    resultDiv.innerHTML = `<strong>${home} vs ${away} (${league})</strong><br>
      Line: ${line} ‚Äî Mean est.: ${mean.toFixed(2)} ‚Äî Std aprox: ${std.toFixed(2)}<br>
      Prob Over: ${(probOver*100).toFixed(2)}% ‚Äî EV Over: ${(evOver*100).toFixed(2)}%<br>
      Kelly Over: ${(kOver*100).toFixed(2)}% ‚Äî Suggested stake (Kelly 0.5): ${suggested.toFixed(2)}%`;

    // draw chart
    safeDrawChart(mean, std, line);

    // save entry
    const entry = {
      ts: Date.now(), league, home, away, line,
      probOver, probUnder, evOver, evUnder,
      oddsOver, oddsUnder, kellyOver: kOver, kellyUnder: kUnder
    };
    saveToHistory(entry);

    log(`Saved: ${home} vs ${away} | POver ${(probOver*100).toFixed(2)}% | EV ${(evOver*100).toFixed(2)}%`);
  }catch(e){ log('Error calcularGuardar: ' + (e.message||e)); console.error(e); resultDiv.innerText = 'Error: ' + (e.message||e); }
}

calcBtn.addEventListener('click', calcularGuardar);

// -------------------- Small helpers --------------------
function log(msg){ const ts = new Date().toLocaleTimeString(); logDiv.innerHTML = `[${ts}] ${msg}<br>` + logDiv.innerHTML; }
document.getElementById('applyKellyFrac').addEventListener('click', ()=>{ /* placeholder: could apply to bankroll */ alert('Aplicar√° Kelly 0.5 sobre stake si implementas bankroll.'); });

// -------------------- Init UI events --------------------
document.getElementById('exampleBtn').addEventListener('click', ()=>{
  leagueSel.value='NBA'; fillTeams();
  teamASel.value='Los Angeles Lakers'; teamBSel.value='Chicago Bulls';
  lineInput.value='224.5'; oddsOverInput.value='1.90'; oddsUnderInput.value='1.90';
  modeSel.value='pre'; liveFields.style.display='none';
  log('Ejemplo cargado: Lakers vs Bulls');
});
document.getElementById('exportJson').addEventListener('click', exportJSON);
document.getElementById('exportCsv').addEventListener('click', exportCSV);

</script>
</body>
</html>

